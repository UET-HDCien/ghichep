## Ghi chép ad-hoc commands

### 1. Giới thiệu

`ad-hoc commands` có thể hiểu đơn giản là gõ và thực thi nhanh nội dung của task mà không cần lưu trữ thông tin lệnh sử dụng cho task đó hoặc phải tạo 1 task cho câu lệnh đó.

Thường sử dụng trong ngữ cảnh thực thi một câu lệnh CLI đơn thuần xuống list các client đã được xác định trong file inventory mà không muốn tạo 1 task hay một playbook phức tạp. Sử dụng câu lệnh ansible với các option để áp các lệnh xuống client.

Thực hiện các vụ mà không cần tạo một playbook trước. Ví dụ: để khởi động lại máy chủ, quản lý dịch vụ, chỉnh sửa cấu hình dòng, sao chép tệp vào một máy chủ, chỉ cần cài đặt một gói...

### 2. Cấu trúc câu lệnh

```
ansible [-i /path/inventory-file] [pattern-host] [-m module] [-a arguments]
```
pattern: Chỉ định thông tin máy client.

module: module sử dụng để thực hiện lệnh xuống client.

arguments: Tham số của module.

**Lưu ý**:

Khi sử dụng ad-hoc commands có module mặc định là `command` (sử dụng trong trường hợp không chỉ định rõ module) và truyền tham số thì sẽ thực hiện luôn câu lệnh đó (truyền ở phần arguments).

Sử dụng "" để truyền tham số vào module lệnh.

Ví dụ:

```
ansible node -a "free -m"
```

```
[root@ansibleserver ~]# ansible node -a "free -m"
10.10.10.153 | CHANGED | rc=0 >>
              total        used        free      shared  buff/cache   available
Mem:           1838         105        1555           8         177        1569
Swap:          4095           0        4095

10.10.10.152 | CHANGED | rc=0 >>
              total        used        free      shared  buff/cache   available
Mem:           1838         107        1553           8         177        1567
Swap:          4095           0        4095
```

### 3. Thực hành ad-hoc commands với các module

**3.1. Thực hiện một command shell tới client**

Sử dụng module `shell`

```
ansible node -m shell -a "df -h"
```
===>

```
[root@ansibleserver ~]# ansible node -m shell -a "df -h"
10.10.10.153 | CHANGED | rc=0 >>
Filesystem                            Size  Used Avail Use% Mounted on
/dev/mapper/centos_ansible10153-root   25G  1.2G   24G   5% /
devtmpfs                              908M     0  908M   0% /dev
tmpfs                                 920M     0  920M   0% /dev/shm
tmpfs                                 920M  8.8M  911M   1% /run
tmpfs                                 920M     0  920M   0% /sys/fs/cgroup
/dev/sda1                            1014M  188M  827M  19% /boot
tmpfs                                 184M     0  184M   0% /run/user/0

10.10.10.152 | CHANGED | rc=0 >>
Filesystem                            Size  Used Avail Use% Mounted on
/dev/mapper/centos_ansible10152-root   25G  1.2G   24G   5% /
devtmpfs                              908M     0  908M   0% /dev
tmpfs                                 920M     0  920M   0% /dev/shm
tmpfs                                 920M  8.8M  911M   1% /run
tmpfs                                 920M     0  920M   0% /sys/fs/cgroup
/dev/sda1                            1014M  188M  827M  19% /boot
tmpfs                                 184M     0  184M   0% /run/user/0
```

**3.2. Module copy**

Coppy file gì đó sang các node còn lại

```
ansible node -m copy -a "src=/root/duy.txt dest=/root/duy.txt"
```

Kết quả

```
[root@ansibleserver ~]# ansible node -m copy -a "src=/root/duy.txt dest=/root/duy.txt"
10.10.10.153 | CHANGED => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python"
    },
    "changed": true,
    "checksum": "2a54c25cd87c1e3bccfb7ecbc6cef7adacc358b1",
    "dest": "/root/duy.txt",
    "gid": 0,
    "group": "root",
    "md5sum": "309c166502e0a0e68ed15b0d16b836f5",
    "mode": "0644",
    "owner": "root",
    "size": 12,
    "src": "/root/.ansible/tmp/ansible-tmp-1564029465.93-191804461490414/source",
    "state": "file",
    "uid": 0
}
10.10.10.152 | CHANGED => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python"
    },
    "changed": true,
    "checksum": "2a54c25cd87c1e3bccfb7ecbc6cef7adacc358b1",
    "dest": "/root/duy.txt",
    "gid": 0,
    "group": "root",
    "md5sum": "309c166502e0a0e68ed15b0d16b836f5",
    "mode": "0644",
    "owner": "root",
    "size": 12,
    "src": "/root/.ansible/tmp/ansible-tmp-1564029465.92-21967436154742/source",
    "state": "file",
    "uid": 0
}
```

```
[root@ansibleserver ~]# ansible node -m shell -a "ls /root"
10.10.10.153 | CHANGED | rc=0 >>
anaconda-ks.cfg
duy.txt

10.10.10.152 | CHANGED | rc=0 >>
anaconda-ks.cfg
duy.txt
```









