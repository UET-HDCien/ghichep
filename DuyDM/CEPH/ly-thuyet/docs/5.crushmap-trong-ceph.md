# Tìm hiểu về crush map trong CEPH

Thuật toán CRUSH xác định cho ta cách lưu trữ và truy xuất dữ liệu bằng cách tính toán vị trí lưu của các dữ liệu. CRUSH cho phép client kết nối, truyền thông nói chuyện trực tiếp với OSD thay vì việc phải thông qua một server trung gian. Với phương pháp lưu trữ và truy xuất dữ liệu CEPH tránh được 1 điểm đơn độc, giảm hiệu suất và giới hạn vật lý đối với khả năng mở rộng.

CEPH yêu cầu bắt buộc phải có một map sử dụng để hình thành kiểu lưu trữ và truy xuất dữ liêu trong OSD và phân phối dữ liệu trong toàn cụm. CRUSH - Controlled Replication Under Scalable Hashing, thay vì lưu trữ metadata, CRUSH tính toán metadata theo yêu cầu.

Crush map chứa danh sách các OSD, một list `buckets` và các quy tắc cho biết cách sao chép dữ liệu trong cluster. Phản ánh lại sơ đồ tổ chức thiết bị vật lý cơ bản của cụm và thiết lập các quy tắc, cơ chế sao lưu dữ liệu trên các thành phần, vị trí vật lý khác nhau.

Khi create một file cấu hình và deploy ceph với ceph-deploy CEPH sẽ tạo crush map mặc định cho cấu hình phù hợp với môi trường triển khai. Khi triển khai với quy mô lớn phải cân nhắc tùy chỉnh crush map việc này sẽ giúp quản lý cụm CEPH, của hiện thiện hiệu suất và đảm bảo an toàn dữ liệu.

Ví dụ: Khi một OSD bị hỏng crush sẽ giúp xác định vị trí bị lỗi để giúp xử lý nhanh chóng.

## CRUSH LOCATION

Vị trí của một OSD theo hệ thống phân cấp của crush map được gọi là `crush location`, diễn tả vị trí theo kiểu key - value.

- Thứ tự của key không quá quan trọng

- Key name (bên trái dấu = ) phải là một trong các giá trị hợp lệ, mặc định bao gồm `root, datacenter, room, row, pod, pdu, rack, chassis, host` nhưng có thể tùy chỉnh bằng các sửa crush maps.

- Không phải tất cả các key cần phải được chỉ định, ceph tự động đặt đặt ceph osd deamon là root=default host=HOSTNAME

**CEPH-CRUSH-LOCATION HOOK**

Mặc định `ceph-crush-location` sẽ tạo một `CRUSH location string` cho một deamon nhất định, vị trí được dựa trên thứ tự ưu tiên (trong file ceph.conf hoặc mặc định root=default host=HOSTNAME).

Có thể quản lý crush maps thủ công bằng tay bằng cách tắt 

`location hook` trong cấu hình.

```
osd crush update on start = false
```

**CUSTOM LOCATION HOOKS**

Có thể tùy chỉnh hook location thay cho hook chung trong cấu trúc OSD phân cấp.

```
osd crush location hook = /path/to/script
```

Hook được truyền qua bỏi một số đối số và sẽ stdout  với CRUSH location.

```
ceph-crush-location --cluster CLUSTER --id ID --type TYPE
```

CLUSTER thường là ceph, id định dạnh OSD, deamon thường là osd.

## EDITING A CRUSH MAP

```
1. Get the CRUSH map.
2. Decompile the CRUSH map.
3. Edit at least one of Devices, Buckets and Rules.
4. Recompile the CRUSH map.
5. Set the CRUSH map.
```

- GET A CRUSH MAP: Xuất thông tin về cluster đang chạy với một tên chỉ định. Lúc này CRUSH maps ở dạng được biên dịch, bạn phải dịch ngược nó trước khi bạn có thể chỉnh sửa nó.

```
ceph osd getcrushmap -o {compiled-crushmap-filename}
```

- DECOMPILE A CRUSH MAP: Biên dịch lại 1 crush map và output ra một file với tên đặc biệt.

```
crushtool -d {compiled-crushmap-filename} -o {decompiled-crushmap-filename}
```

- COMPILE A CRUSH MAP: Thực hiện sau khi đã chỉnh sửa crush map.

```
crushtool -c {decompiled-crush-map-filename} -o {compiled-crush-map-filename}
```
- SET A CRUSH MAP

```
ceph osd setcrushmap -i  {compiled-crushmap-filename}
```

## CRUSH MAP PARAMETERS

4 thành phần chính của crush map:

- Devices: Bao gồm các thiết bị lưu trữ

- Bucket Types: Định nghĩa các kiểu của bucket được sử dụng trong hệ thống phân cấp crus. Bao gồm tậ hợp các storage location (rows, racks, chassis, hosts...) 

- Bucket Instances: Khi xác định mỗi bucket type, phải khai báo các bucket instances cho host.

- Rules: Bao gồm các quy tắc lựa chọn bucket.




